{% extends 'layout.html' %}

{% block title %} DEVIL {% endblock %}

{% block head %}
  {% parent %}
  <style>
  .log {
    border: 1px solid #CCC;
    padding: 10px;
    border-radius: 5px;
  }
  .gauge {
    border: 1px solid black;
    margin: 15px 0 15px 0;
    height: 30px;
  }
  .gauge > .bar {
    background-color: #CCF;
    height: 100%;
  }
  .dungeon {
    padding: 5px;
    background-color: #DDD;
    min-height: 200px;
  }
  .placeholder {
      background-color: red;
  }
</style>
{% endblock %}

{% block content %}
  <div class="col-md-12">
    <div class="row">
      <div class="col-md-2">
        <h1>DEVIL</h1>
      </div>
      <div class="col-md-10">
        <h1><div class="pull-right" id="timer">TIMER: 60</div></h1>
      </div>
    </div>
    <hr />
    <div class="col-md-3">
      <!-- DEVIL -->
      <h4>KINGDOM</h4>
      <div class="panel-group">
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#devil">
                {% if devil.aka %}
                {{ devil.aka }}
                {% else %}
                {{ devil.name }}
                {% endif %}
                <div style="color: #BBB" class="pull-right">Lv.{{ devil.level }}</div>
              </a>
            </h4>
          </div>
          <div class="panel-collapse collapse in" id="devil">
            <div class="panel-body">
              <div class="devil">
                <img src="http://lorempixel.com/200/200/people" class="img-thumbnail" />
                <div style="margin-top: 10px;" class="btn-group btn-group-justified">
                  <div class="btn-group">
                    <skill type="button" class="btn btn-default">{{ devil.skills[0] }}</skill>
                  </div>
                  <div class="btn-group">
                    <skill type="button" class="btn btn-default">{{ devil.skills[1] }}</skill>
                  </div>
                </div>
                <h4>STATS</h4>
                <div class="row">
                  <div class="col-xs-4">체력</div>
                  <div class="col-xs-8">{{ devil.current_health_point }}/{{ devil.health_point}}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">경험치</div>
                  <div class="col-xs-8">{{ devil.current_experience }}/{{ devil.target_experience }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">공속</div>
                  <div class="col-xs-8">{{ devil.attack_speed_per_sec }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">물리</div>
                  <div class="col-xs-8">{{ devil.physical_damage }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">마법</div>
                  <div class="col-xs-8">{{ devil.magic_damage }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">방어</div>
                  <div class="col-xs-8">{{ devil.armor }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">저항</div>
                  <div class="col-xs-8">{{ devil.magic_resist }}</div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- DEVIL -->
      </div>

      <div id="colonies" class="panel-group">
        <h4>COLONIES</h4>
      </div>

      <h4>STATS</h4>
      <button class="btn btn-block btn-default">활동력</button>
      <button class="btn btn-block btn-default">돈</button>
      <button class="btn btn-block btn-default">거주지</button>
      <button class="btn btn-block btn-default">레벨</button>
    </div>

    <!-- CITIES -->
    <div class="col-md-3">
      {% if cities.length %}
      <h4>CITIES</h4>
      <div class="panel-group">
      {% for city in cities %}
        <div data-id="city-{{ city.id }}" class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#city-{{ city.id }}">
                {{ city.name }}
                <div style="color: #BBB" class="pull-right">{{ city.level }}</div>
              </a>
            </h4>
          </div>
          <div class="panel-collapse collapse" id="city-{{ city.id }}">
            <div class="panel-body">
              <div>
                <img src="http://lorempixel.com/200/200/city" class="img-thumbnail" />
                <div class="gauge">
                  <div class="bar" style="width: 100%"></div>
                </div>
                <h4>STATS</h4>
                <div class="row">
                  <div class="col-xs-4">인구</div>
                  <div class="col-xs-8">{{ city.population }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">경제력</div>
                  <div class="col-xs-8">{{ city.economy_level }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">병력</div>
                  <div data-type="soldiers" class="col-xs-8">{{ city.soldiers }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">군사력</div>
                  <div class="col-xs-8">{{ city.army_level }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">방어도</div>
                  <div class="col-xs-8">{{ city.defense }}</div>
                </div>
              </div>
              <hr />
              <attack class="btn btn-block btn-primary" data-city="{{ city.id }}" data-toggle="modal" data-target="#myModal">공격(Modal)</attack>
            </div>
          </div>
        </div>
      {% endfor %}
      </div>
      {% endif %}
      <!-- CITIES -->

      <!-- MONSTERS -->
      {% if cities.length %}
      <h4>MONSTERS</h4>
      <div class="panel-group">
      {% for monster in monsters %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#monster-{{ monster.id }}">
                {{ monster.name }}
                <div style="color: #BBB" class="pull-right">{{ city.level }}</div>
              </a>
            </h4>
          </div>
          <div class="panel-collapse collapse" id="monster-{{ monster.id }}">
            <div class="panel-body">
              <div>
                <img src="http://lorempixel.com/200/200" class="img-thumbnail" />
                <div class="gauge">
                  <div class="bar" style="width: 60%"></div>
                </div>
                <h4>STATS</h4>
                <div class="row">
                  <div class="col-xs-4">HP</div>
                  <div class="col-xs-8">{{ monster.health_point }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">공속</div>
                  <div class="col-xs-8">{{ monster.attack_speed_per_sec }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">물리공격</div>
                  <div class="col-xs-8">{{ monster.physical_damage }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">마법공격</div>
                  <div class="col-xs-8">{{ monster.magic_damage }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">방어력</div>
                  <div class="col-xs-8">{{ monster.armor }}</div>
                </div>
                <div class="row">
                  <div class="col-xs-4">마법저항</div>
                  <div class="col-xs-8">{{ monster.magic_resist }}</div>
                </div>
              </div>
              <hr />
              <button class="btn btn-block btn-default">구입</button>
            </div>
          </div>
        </div>
      {% endfor %}
      </div>
      {% endif %}
      <!-- MONSTERS -->

      <h4>UPGRADE</h4>
      <upgrade class="btn btn-block btn-default">돈</upgrade>
      <h4>SHOP</h4>
      <shop class="btn btn-block btn-default">돈</shop>
    </div>

    <div class="col-md-6">
      <h4>DUNGEON</h4>
      <div class="row">
        <div class="col-xs-2">
          <h5>6F</h5>
        </div>
        <div class="col-xs-2">
          <h5>5F</h5>
        </div>
        <div class="col-xs-2">
          <h5>4F</h5>
        </div>
        <div class="col-xs-2">
          <h5>3F</h5>
        </div>
        <div class="col-xs-2">
          <h5>2F</h5>
        </div>
        <div class="col-xs-2">
          <h5>1F</h5>
        </div>
      </div>
      <div class="row">
        <div data-floor="6f" class="col-xs-2 dungeon">
          <keeper class="btn btn-block btn-default">발록</keeper>
        </div>
        <div data-floor="5f" class="col-xs-2 dungeon">
          <keeper class="btn btn-block btn-default">데몬</keeper>
          <keeper class="btn btn-block btn-default">오우거</keeper>
        </div>
        <div data-floor="4f" class="col-xs-2 dungeon">
          <keeper class="btn btn-block btn-default">고블린</keeper>
          <keeper class="btn btn-block btn-default">고블린</keeper>
        </div>
        <div data-floor="3f" class="col-xs-2 dungeon">
          <keeper class="btn btn-block btn-default">데몬</keeper>
        </div>
        <div data-floor="2f" class="col-xs-2 dungeon">
          <keeper class="btn btn-block btn-default">트롤</keeper>
          <keeper class="btn btn-block btn-default">오크</keeper>
          <keeper class="btn btn-block btn-default">트롤</keeper>
        </div>
        <div data-floor="1f" class="col-xs-2 dungeon">
          <keeper class="btn btn-block btn-default">
            <div style="background-color: red; width: 50%;">
              오크
            </div>
          </keeper>
          <keeper class="btn btn-block btn-default">
            <div style="background-color: red; width: 50%;">
              오크
            </div>
          </keeper>
        </div>
      </div>
      <h4>LOG</h4>
      <!-- <div id="log" class="log"></div> -->
      <button class="btn btn-default" id="test">TEST</button>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="myModalLabel">전투</h4>
        </div>
        <div class="modal-body">
          <h5>LOG</h5>
          <div id="log" class="log"></div>
          <hr />
          <attack id="modalAttack" class="btn btn-block btn-primary">공격시작</attack>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
  $(document).ready(function() {
    var cityId;
    var $log = $('#log');

    $(document).on('click', '#test', function () {
      $.ajax({
        type: 'POST',
        url: '/devil/status',
        success: function (data, status) {
          if ( data.result === 'success' ) {
            console.log('hp:', data.devil.current_health_point);
            console.log('ap:', data.devil.current_action_point);
          }
          return;
        },
        error: function (error) {
          console.log('error:', error);
        }
      });
    });

    $(document).on('click', 'attack', function () {
      var isModalOpenButton = ( $(this).data('toggle') ) ? true : false;

      if ( isModalOpenButton ) {
        cityId = $(this).data('city');
        console.log('cityId:', cityId);
        return;
      }

      $p = $('<p></p>').text('전투시작');
      $log.html('');
      $log.append($p);

      var turnInterval = setInterval(function () {
        $.ajax({
          type: 'POST',
          url: '/devil/attack',
          data: { 'city_id': cityId },
          success: function (data, status) {
            // 1턴씩 서버에서 처리되도록 하고, 1턴이 완료되어 response 가 넘어오면 제귀호출 하는걸로 개발
            console.log('data:', data);
            for ( var i in data.logs ) {
              $p = $('<p></p>').text(data.logs[i]);
              $log.append($p);
            }

            if ( data.conclusion ) {
              clearInterval(turnInterval);
              $p = $('<p></p>').text('전투종료');
              $log.append($p);
            }
          },
          error: function (error) {
            console.log('error:', error);
            alert('오류');
          }
        });
      }, 1000);
    });

    $('.dungeon').sortable({
      connectWith: '.dungeon',
      placeholder: "placeholder btn btn-block"
    });
  });
  </script>
{% endblock %}